:::info
TPI: 彭詩翔 Riley Peng: <riley.peng@tpisoftware.com>
:::

# 7/11與通路玟君請教
1. APP串接是直接打後端API(您們負責的)
APP==>通路中台==>業務中台(我們)
==目前沒有API清單，現在請TPI蒐集==
目前通路中台有請TPI設計error handle

2. 針對環境的話分這邊跟Water合作後大概知道怎麼切的? 還是你們有規範?
強烈要求TPI說明怎麼在local啟動並協助維運人員在自己的電腦能啟動專案

3. 在CustomerController中，存在 updatePhone method，有允許客戶改變電話號碼嗎?
Ans: 沒有任何機會可以改變電話

4. 一個人就是一次註冊機會，如何在已完成註冊的情況下，再啟動第二筆貸款申請?
不需要這樣考慮，申請能借多少就是多少

# 請教宜峰
1.假設現在有新的版本更新，舊版本的合約template會怎麼處理呢?  
Ans: 舊合約會停用
2.我們需要保留所有版本的合約template?
Ans: 會需要先保留,日後可能會調閱合約生效日是否等於系統的上板日
3.如果一個用戶申請到一半，合約的template被更新了，用戶是要重新再簽一份還是舊的繼續往下跑跑完就好?
Ans: HES這份合約會是在跑完流程後,去抓最新的合約版本,所以在APP操作申請時不會有影響~

# APP-API

- [x] ==詢問water== : 請說明APP呼叫此method (getApplicationAgreementAppTaskV1) 拿到bucketName+agreementKey 會如何往下和GCP互動?
    - StorageKeyUtil.generateApplicationAgreementKey() 用法??
``` java
 var agreementKey = StorageKeyUtil.generateApplicationAgreementKey(customerId, applicationId);
        return ApplicationAgreementAppTask.builder()
                .bucketName(bucketName)
                .storageKey(agreementKey)
                .build();
```

(moved)
- [x] 請說明APP呼叫此method (getCreditLineV1) 回覆的結果為什麼是這樣? 為什麼其他欄位都是100000????
Ans: ==與通路討論== :目前沒有使用這支API

```java=
return CreditLine.builder()
            .bnplCreditLineAvailable(new BigDecimal("100000"))
            .cashLoanCreditLineAvailable(new BigDecimal("100000"))
            .outstanding(new BigDecimal("100000"))
            .totalCreditLimit(totalCreditLimit)
            .build();
```


# BackOffice-api

(moved)
- [X] getApplicationStatusReport(): how to download excel??
1.應該是讀取DB之後再透過
 GETMAPPING 設定 produces = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
2. return  ResponseEntity"<"InputStreamResource">"來下載excel
![](https://hackmd.io/_uploads/HkZ4dSFK3.png)


- [x] 舉例: taskController = methodOn(TaskController.class) 這個用法??
    - 以及往下呼叫此controller內部方法?? attachmentUri=linkTo(methodOn(TaskController.class).getTaskAttachment(taskId, attachmentId, null)).toUri()
ref: https://www.baeldung.com/spring-hateoas-tutorial
:::spoiler
The WebMvcLinkBuilder offers rich support for Spring MVC Controllers. The following example shows how to build HATEOAS hyperlinks based on the getOrdersForCustomer() method of the CustomerController class:
```java
Link ordersLink = linkTo(methodOn(CustomerController.class)
  .getOrdersForCustomer(customerId)).withRel("allOrders");

```
The methodOn() obtains the method mapping by making dummy invocation of the target method on the proxy controller and sets the customerId as the path variable of the URI.
:::

![](https://hackmd.io/_uploads/rJs0crYKn.png)


==有時間的話深入了解以下annotation==
```java=
 @Parameter(example = "ey..iJ",
            name = "access_token",
            schema = @Schema(type = "string"),
            in = ParameterIn.QUERY,
            description = "Only jwt token without Bearer")
```



- [x] 請解釋用法: 在呼叫 camundaClient.getTaskById() 的實際作用方式??
    - camundaClient是interface層寫了 @GetMapping("api/bo-user/tasks/{taskId}") 
    - 但還有實際上又透過boUserService去實作，為何採用這種設計?有甚麼目的?
Ans:是透過spring boot feignClient的寫法來達到目的

- [x] 請解釋用法 如果用到Camunda service(runtmeService,taskService...) 那些查找的條件會對應哪一些act_xxx table??
    
    - [x] 目前在HES內有哪些SignalEvent代號?(Q1)Ans:目前沒有整理請自行閱讀
    - [x] 或是processInstance代號? 可以提供清單嗎?(Q2)Ans:目前沒有整理請自行閱讀
```java=
// Q1
runtimeService.createSignalEvent 
        - retry-application-%s".formatted(applicationId)

// Q2
runtimeService.createProcessInstanceQuery()
                .variableValueEquals(DOCUMENT_TEMPLATE_ID, documentTemplateId)
                .list()
                .stream()
                .map(ProcessInstance::getProcessInstanceId)
                .forEach(processInstanceId -> runtimeService.deleteProcessInstanceIfExists(processInstanceId, null, true, false, true, true));

```

- [X] 在CustomerController中，存在 updatePhone method，有允許客戶改變電話號碼嗎?
 ==詢問宜峰or通路是否有這件事情存在==
 Ans:目前不給User改電話號碼
- 如何透過keycloak_id就可以mapping 出對應的 CustomerRealm UsersResource 資料??
Ans:了解keycloak對於設定面應該可以比較清楚

- [ ] TaskController->(api/tasks/{taskId}/attachments/{id}): 呼叫 StorageService 進行資料儲存，==要如何判斷存到哪裡? Config設定??== 
    - 會透過Storage寫到哪裡??? GcpStorage? LocalStorage? LoggingStorage?==
    
- [ ] 請協助說明StorageAutoConfiguration對應上方那些xxxStorage.java的使用與設定?
![](https://hackmd.io/_uploads/SyZzUgZK3.png)

- [x] DocumentController-> (api/document-templates/{id})是真的從DB刪除template，template有版本號?是否有template新舊版的問題?


# Camunda 

## create application

- [X] Camunda流程，大部分都類似是前端打來去啟動流程(像create-application.bpmn)，那是否有其他啟動方式?
Ans: 目前都是主流程call Activity而已

起點:
```java=
runtimeService.startProcessInstanceByKey(
    CREATE_APPLICATION_PROCESS_DEFINITION_KEY, 
    businessKey, 
    Map.of(CUSTOMER_ID, customerId, APPLICATION_ID, applicationId
));
```

- [X] input:skipRegistration怎麼沒給?????
Ans: 先前用web操作時所創立的參數，現在用不到，但沒有移除..目前直接略過
![](https://hackmd.io/_uploads/S1bIepid2.png)


透過Start spinner設定:
![](https://hackmd.io/_uploads/BkrFb6ou2.png)
Ans: 透過Signal去找到對應sub event，進行一個動作(User Assignment)，最後都會透過Finish application 去結束 event & spinner
![](https://hackmd.io/_uploads/HyxWtxrYh.png)



- [ ] businessKey 是對應signal欄位? 在程是中是透過 execution.processBusinessKey 取出嗎?
Ans: 程式裡定義的businessKey和 camunda定義的其實沒有關聯 (就是自訂義辨識)

- [x] 當process start時,businessKey會存到哪一張table(act_ru_task or??)
Ans:沒有特別保存在哪寫table，只是camunda用來判斷流程是否還在跑而已

- [ ] Map.of裡面存放的資料，可以透過In mapping propagation: propagate all variable 不斷傳遞下去???使用的範圍有哪些?
Ans: TPI說他沒有研究
![](https://hackmd.io/_uploads/SJ8TlTsdn.png)



- 在Call ACTIVITY時，透過"In mappings"將變數傳入到流程中
 **Type**
    - Source: 把畫面上的參數傳到Activity
    - Source expression: 額外定義的表達式或字串往裡面傳
![](https://hackmd.io/_uploads/BJtEDpjO3.png)



before,after決定每一次流程的保存點(角度是依照選擇的流程來定)
例如有一個decision/function
如果選擇before 當下有錯的decision/function會重新作執行
選擇after 錯誤也一漾停在decision但是再往下執行時流程會往下跑，並不會重新執行decision

可以看到每個斷點的保存點 (有關before,after的設定)
![](https://hackmd.io/_uploads/BJzmjeSF3.png)
![](https://hackmd.io/_uploads/By8-3ert2.png)
transaction boundary就是用來界定某一次錯誤要rollback的範圍


## notify customer application created

- notification.bpmn傳入的值與create-application.bpmn對不上
- ![](https://hackmd.io/_uploads/H1T7Tasd3.png)

==要了解發生錯誤的時候怎麼進去handle process==
![](https://hackmd.io/_uploads/SkGFzRjd2.png)

- [x] 計算pause time的用意? 使用了amlAutoRejectDelegate，會得到什麼結果?如何使用?:question: 感覺是共用，名稱應該需要重新定義? =>目前應該是不會重新定義名稱

- [ ] CompleteErrorDelegate為什麼是這樣運作? 請協助說明retry機制是怎麼運作的(包含元件使用)

- [ ] Event Listener Type 是 end 是哪裡的End????==
![](https://hackmd.io/_uploads/rkZInJndh.png)

- [X] 到底applicationStatus要設定為PAUSE 還是 PENDING??? 看起來執行了兩次狀態變更?? 可以協助說明不同狀態的定義情境?
A:三角形空心代表要人員介入，等User進來處理後再將狀態改為PENDING
![](https://hackmd.io/_uploads/rkkVAy3d3.png)




:question:delegate 這個節點哪裡來?
![](https://hackmd.io/_uploads/ry86abnu3.png)

## internal credit data


**IN stakeholder-data.bpm**



透過打別人API之後利用objectMapper轉型，且透過execution.setVariable(key, responseMap);方法將資料傳到流程內
![](https://hackmd.io/_uploads/BJ1LPGn_h.png)
- [x] 呈上，response format是什麼???? 是否有外部服務API規格書? 
Ans: 打打看，看format再來改
![](https://hackmd.io/_uploads/rysvKehd3.png)

